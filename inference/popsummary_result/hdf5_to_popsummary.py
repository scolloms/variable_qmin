from matplotlib import pyplot as plt
import numpy as np
import h5py
import corner
import seaborn
import pandas
import popsummary

def hdf5_to_popsummary_hyperposterior(hdf5_filename):
    """
    function to convert hyperposterior samples from the json format
    to popsummary h5
    """
    res = h5py.File(hdf5_filename)
    hyperparameters = list(res['posterior'].keys())
    out = np.array(list(map(lambda hyperparam: res['posterior'][hyperparam],hyperparameters))).T
    return out, hyperparameters

rundir = 'O4a_variablem2min_nestlenlive500/result/bbh_mass_two_component_primary_mass_ratio_variable_qmin_redshift_powerlaw_result.hdf5'
hdf5_filename = 'parabola_m2min_gamma_max_35_result'

hyp_out, hyperparameters = hdf5_to_popsummary_hyperposterior(f'{rundir}')

events ='GW150914_095045, GW151012_095443, GW151226_033853, GW170104_101158, GW170608_020116, GW170729_185629, GW170809_082821, GW170814_103043, GW170818_022509, GW170823_131358, GW190403_051519, GW190408_181802, GW190412_053044, GW190413_052954, GW190413_134308, GW190421_213856, GW190426_190642, GW190503_185404, GW190512_180714, GW190513_205428, GW190514_065416, GW190517_055101, GW190519_153544, GW190521_030229, GW190521_074359, GW190527_092055, GW190602_175927, GW190620_030421, GW190630_185205, GW190701_203306, GW190706_222641, GW190707_093326, GW190708_232457, GW190719_215514, GW190720_000836, GW190725_174728, GW190727_060333, GW190728_064510, GW190731_140936, GW190803_022701, GW190805_211137, GW190814_211039, GW190828_063405, GW190828_065509, GW190910_112807, GW190915_235702, GW190916_200658, GW190917_114630, GW190924_021846, GW190925_232845, GW190926_050336, GW190929_012149, GW190930_133541, GW191103_012549, GW191105_143521, GW191109_010717, GW191113_071753, GW191126_115259, GW191127_050227, GW191129_134029, GW191204_110529, GW191204_171526, GW191215_223052, GW191216_213338, GW191222_033537, GW191230_180458, GW200112_155838, GW200128_022011, GW200129_065458, GW200202_154313, GW200208_130117, GW200208_222617, GW200209_085452, GW200216_220804, GW200219_094415, GW200220_061928, GW200220_124850, GW200224_222234, GW200225_060421, GW200302_015811, GW200306_093714, GW200308_173609, GW200311_115853, GW200316_215756, GW200322_091133, S230601bf, S230605o, S230606d, S230608as, S230609u, S230624av, S230627c, S230628ax, S230630am, S230630bq, S230702an, S230704f, S230707ai, S230708bi, S230708cf, S230709bi, S230723ac, S230726a, S230729z, S230731an, S230802aq, S230805x, S230806ak, S230811n, S230814ah, S230814r, S230819ax, S230820bq, S230822bm, S230824r, S230825k, S230831e, S230904n, S230911ae, S230914ak, S230919bj, S230920al, S230922g, S230922q, S230924an, S230927be, S230927l, S230928cb, S230930al, S231001aq, S231005ah, S231005j, S231008ap, S231014r, S231020ba, S231028bg, S231029y, S231102w, S231104ac, S231108u, S231110g, S231112ag, S231113bw, S231114n, S231118ab, S231118an, S231118d, S231127cg, S231129ac, S231206ca, S231206cc, S231213ap, S231223j, S231224e, S231226av, S231231ag, S240104bl, S240109a'.split(',')
event_vars=['mass_1', 'mass_ratio', 'a_1', 'a_2', 'cos_tilt_1', 'cos_tilt_2', 'redshift']

popfile = popsummary.popresult.PopulationResult(
    f'{hdf5_filename}.h5',
    hyperparameters = hyperparameters,
    events = events,
    event_parameters = event_vars,
        )
popfile.set_hyperparameter_samples(hyp_out, overwrite=True)